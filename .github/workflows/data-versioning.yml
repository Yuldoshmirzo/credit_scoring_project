name: Data Versioning & Model Training Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'data/**'
      - 'src/**'
      - 'requirements.txt'
  pull_request:
    branches: [ main ]

jobs:
  setup-data:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Install DVC
      - name: Install DVC
        run: |
          pip install dvc

      # Pull data from DVC remote (if configured with GitHub secret)
      - name: Pull data with DVC
        env:
          DVC_REMOTE: ${{ secrets.DVC_REMOTE_PATH }}
        run: |
          if [ ! -z "$DVC_REMOTE" ]; then
            dvc remote add -d storage $DVC_REMOTE
            dvc pull
          fi

      - name: Verify data
        run: |
          ls -lh data/UCI_Credit_Card.csv
          echo "Data file size: $(du -h data/UCI_Credit_Card.csv | cut -f1)"

  test:
    needs: setup-data
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short

      - name: Lint with pylint
        run: |
          pylint src/ --disable=all --enable=E,F --fail-under=9.0 || true

  data-integrity:
    needs: setup-data
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install DVC
        run: pip install dvc

      - name: Check DVC files
        run: |
          echo "DVC files in repo:"
          find . -name "*.dvc" -type f

      - name: Validate DVC tracking
        run: |
          dvc dag || echo "No DVC pipeline defined"
          dvc status || echo "Data integrity check passed"
